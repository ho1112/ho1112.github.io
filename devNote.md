# 댓글 시스템 개발 노트

> **프로젝트**: Echo Chamber (가제) - 자체 댓글 시스템 구축  
> **시작일**: 2025년 8월 26일  
> **목표**: 기존 Giscus 댓글 시스템을 자체 제작한 댓글 컴포넌트로 교체

---

## 📋 프로젝트 개요

### 🎯 핵심 아이디어

- **기존 문제점**: Giscus는 외부 서비스 의존성, 커스터마이징 한계
- **해결 방안**: 자체 댓글 컴포넌트 + 외부 댓글 API와 통신
- **차별화**: 독립적인 댓글 관리 시스템, 완전한 커스터마이징 가능

### 🏗️ 아키텍처 설계

- **"댓글 컴포넌트"**: React 컴포넌트로 댓글 UI 구현
- **"댓글 API"**: 외부 댓글 시스템과 통신 (향후 구현 예정)
- **"댓글 관리 시스템"**: 별도 리포지토리에서 댓글 관리 (향후 구현 예정)

---

## 🕐 개발 타임라인

### **2025-08-26 19:00** - 프로젝트 시작

- **작업**: `design.md` 파일 분석 및 댓글 시스템 요구사항 파악
- **결과**: API 명세서, 작업 계획서, 댓글/봇 시스템 계획서 확인 완료

### **2025-08-26 19:15** - 기존 Giscus 컴포넌트 코멘트아웃

- **파일**: `src/app/blog/[language]/[category]/[slug]/page.tsx`
- **작업**: Giscus import 및 사용 부분을 코멘트아웃
- **결과**: 기존 댓글 시스템은 유지하되 비활성화

### **2025-08-26 19:30** - Mock 데이터 생성

- **파일**: `src/lib/mock-data/comments.js`
- **내용**: API 명세서에 맞는 가짜 댓글/대댓글 데이터 6개 생성
- **특징**:
  - 대댓글은 1단계 깊이로만 들여쓰기
  - 봇 댓글과 일반 댓글 구분
  - Dicebear API로 아바타 생성
  - 일본 시간 기준 날짜 설정

### **2025-08-26 19:45** - 댓글 아이템 컴포넌트 생성

- **파일**: `src/components/CommentItem.tsx`
- **주요 기능**:
  - 개별 댓글 렌더링
  - 대댓글 들여쓰기 및 화살표 표시
  - 봇 댓글 배지 표시
  - 상대적 시간 표시 (초 단위까지)
  - 다국어 지원 (한국어/일본어)

### **2025-08-26 20:00** - 댓글 폼 컴포넌트 생성

- **파일**: `src/components/CommentForm.tsx`
- **주요 기능**:
  - 새 댓글 작성 폼
  - 답글 작성 폼 (대댓글)
  - 닉네임 입력 필드
  - 1000글자 제한
  - 다국어 지원
  - 로딩 상태 표시

### **2025-08-26 20:15** - 댓글 섹션 메인 컴포넌트 생성

- **파일**: `src/components/CommentSection.tsx`
- **주요 기능**:
  - 댓글 목록과 작성 폼 통합 관리
  - Mock 데이터 로딩 및 렌더링
  - 댓글 작성 시뮬레이션
  - 로딩 상태 및 에러 처리
  - 댓글 순서: 목록 → 작성 폼

### **2025-08-26 20:30** - 새로운 댓글 컴포넌트를 블로그에 통합

- **파일**: `src/app/blog/[language]/[category]/[slug]/page.tsx`
- **작업**: CommentSection 컴포넌트 추가
- **결과**: 블로그 포스트에 새로운 댓글 시스템 표시

### **2025-08-26 20:45** - 필요한 의존성 설치

- **패키지**: `date-fns` 설치
- **목적**: 댓글 시간 표시를 위한 날짜 포맷팅
- **결과**: 성공적으로 설치 완료

### **2025-08-26 21:00** - UI 디자인 최적화

- **작업**: 댓글 입력 폼 디자인 개선
- **변경 내용**:
  - '새 댓글 작성' 제목 제거
  - '이름' → '닉네임'으로 변경
  - '댓글' 라벨 제거
  - 더 깔끔하고 직관적인 UI

### **2025-08-26 21:15** - 댓글 구분선 및 스타일링

- **작업**: 댓글들 사이에 구분선 추가
- **구현**: `border-b border-gray-200 dark:border-gray-700`로 가로 구분선
- **결과**: 댓글들이 시각적으로 잘 구분됨

### **2025-08-26 21:30** - 대댓글 화살표 표시 시스템

- **작업**: 대댓글에 '↪︎' 화살표 추가
- **구현**: `w-8` (32px) 고정 너비로 화살표 영역 할당
- **결과**: 대댓글이 더 직관적으로 구분됨

### **2025-08-26 21:45** - 댓글 시간 표시 시스템 구축

- **작업**: 상대적 시간과 절대 날짜를 조합한 시간 표시
- **구현 내용**:
  - **24시간 이내**: "30초 전", "5분 전", "2시간 전" (초 단위까지)
  - **24시간 이상**: "2025년 1월 26일 18:36:27" (시:분:초 포함)
  - **언어별 지원**: 한국어/일본어 시간 형식
- **기술**: `differenceInSeconds`, `differenceInMinutes`, `differenceInHours` 함수 활용

### **2025-08-26 22:00** - 댓글 길이 제한 설정

- **작업**: 댓글 입력 폼에 1000글자 제한 추가
- **구현**: `<textarea maxLength={1000}>` 속성 추가
- **특징**: 언어와 상관없이 정확히 1000글자까지 입력 가능

### **2025-08-26 22:30** - TanStack Query 설정 및 API 연동 준비

- **패키지**: `@tanstack/react-query` 설치
- **파일**: `src/lib/query-client.ts` 생성 및 QueryClient 설정
- **Provider**: `src/app/layout.tsx`에 QueryClientProvider 추가
- **커스텀 훅**: `src/hook/useComments.ts`로 댓글 관리 로직 구현
- **목표**: Mock 데이터를 실제 API 호출로 쉽게 교체할 수 있는 구조 준비

### **2025-08-26 23:00** - 토스트 알림 시스템 구현

- **기능**: 댓글 작성 성공/실패 시 사용자 친화적 알림
- **구현**: `useToast` 훅을 활용한 토스트 시스템
- **스타일**:
  - 성공: 기본 파란색 스타일
  - 에러: `variant="destructive"` (빨간색 스타일)
- **다국어**: 한국어/일본어 지원
- **자동 새로고침**: 댓글 작성 후 자동으로 목록 업데이트

### **2025-08-26 23:15** - 에러 처리 및 UI 개선

- **에러 처리**: try-catch를 통한 적절한 에러 처리
- **토스트 알림**: 에러 발생 시 빨간색 에러 메시지 표시
- **댓글 간격 조정**: `py-4` → `py-2`로 조정하여 적절한 간격 확보
- **컴파일 에러 해결**: import 경로 및 타입 에러 수정

### **2025-08-26 23:45** - API 연동 및 환경변수 설정 완료

- **작업**: 실제 API 서버와 연동하여 댓글 시스템 완성
- **구현 내용**:
  - **복합 키 시스템**: `${language}-${category}-${slug}` 형태로 고유 식별
  - **API 연동**: `localhost:3001` API 서버와 통신
  - **환경변수 설정**: `NEXT_PUBLIC_COMMENT_LOCAL_API_BASE_URL`, `NEXT_PUBLIC_COMMENT_PROD_API_BASE_URL`
  - **데이터베이스 분리**: `dev_comments` (로컬), `prod_comments` (프로덕션) 테이블
- **결과**: 로컬에서 실제 API를 통한 댓글 작성/조회/대댓글 완벽 동작

### **2025-08-26 23:50** - 프로덕션 환경 준비 완료

- **작업**: GitHub Pages 배포를 위한 환경별 설정 완료
- **구현 내용**:
  - **환경별 API URL**: 로컬/프로덕션 환경 자동 전환
  - **환경변수 강제**: 설정되지 않으면 빌드 시 에러 발생으로 안전성 확보
  - **복합 키 방식**: `ko-weekly-250823`, `ja-deepDive-250823` 등으로 댓글 분리
  - **API 응답 파싱**: `{ success: true, data: Comment[] }` 구조 지원
- **결과**: 로컬과 프로덕션 환경을 명확하게 분리하여 관리 가능

---

## 🔍 발견된 문제점들과 해결책

### **Giscus 스타일 영향 문제**

- **문제**: `prose` 클래스가 댓글 컴포넌트에 영향을 주어 `<p>` 태그에 과도한 마진 적용
- **해결**: `not-prose` 클래스를 CommentSection에 추가하여 prose 스타일 완전 차단
- **교훈**: Tailwind CSS의 prose 클래스는 MDX 콘텐츠에만 적용해야 함

### **대댓글 시각적 표현 방식**

- **초기 시도**: `border-l` (왼쪽 세로선)으로 계층 구조 표현
- **문제점**: Reddit과 다른 스타일, 복잡한 구현
- **최종 해결**: 들여쓰기(`ml-8`) + 화살표(`↪︎`) 조합으로 단순하고 직관적인 표현
- **결과**: 사양서 요구사항(1단계 깊이)에 정확히 부합

### **시간 표시 시스템 최적화**

- **초기 시도**: `formatDistanceToNow`의 `includeSeconds: true` 옵션 사용
- **문제점**: "약" 같은 부사어가 자동으로 추가되어 깔끔하지 않음
- **해결**: `formatDistance` 사용 + 수동으로 초/분/시간 단위 계산
- **장점**: 더 정확하고 커스터마이징 가능한 시간 표시

### **Mock 데이터 시간대 설정**

- **문제**: `created_at`이 UTC 시간(`Z` 포함)으로 설정되어 일본 시간과 맞지 않음
- **해결**: 모든 날짜에서 `Z` 제거하여 일본 시간 기준으로 설정
- **결과**: 한국 사용자(1시간 차이), 일본 사용자(정확), 기타 지역(일본 시간 기준) 모두 적절한 시간 표시

### **TanStack Query 설정 문제**

- **문제**: Server Component에서 Client Component로 QueryClient 전달 시 직렬화 에러
- **해결**: `Providers.tsx` 컴포넌트를 생성하여 Client Component로 분리
- **결과**: 안전한 QueryClient 전달 및 에러 해결

### **타입 호환성 문제**

- **문제**: Mock 데이터와 실제 API 타입 간의 불일치
- **해결**: `Comment` 인터페이스 정의 및 `parent_id` 타입 명시적 처리
- **결과**: 타입 안전성 확보 및 컴파일 에러 해결

### **API 연동 및 환경변수 설정**

- **문제**: 로컬과 프로덕션 환경에서 다른 API URL 사용 필요
- **해결**: 환경변수로 API URL 분리 및 환경별 자동 전환
- **구현**: `NODE_ENV`에 따라 `NEXT_PUBLIC_COMMENT_LOCAL_API_BASE_URL` 또는 `NEXT_PUBLIC_COMMENT_PROD_API_BASE_URL` 선택
- **안전성**: 환경변수 설정되지 않으면 빌드 시 에러 발생으로 잘못된 설정 방지

### **복합 키 시스템 구현**

- **문제**: 같은 slug를 가진 포스트가 언어/카테고리별로 다른 댓글을 가져야 함
- **해결**: `${language}-${category}-${slug}` 형태의 복합 키 생성
- **예시**: `ko-weekly-250823`, `ja-deepDive-250823`
- **장점**: 데이터베이스 단순화, API 호출 단순화, 성능 향상

### **API 응답 파싱 최적화**

- **문제**: 백엔드에서 `{ success: true, data: Comment[] }` 형태로 응답하지만 프론트엔드에서 배열을 기대
- **해결**: 응답 구조를 유연하게 파싱하여 배열, `{ data: [] }`, `{ comments: [] }` 모두 지원
- **결과**: 백엔드 응답 구조 변경에도 안전하게 대응 가능

---

## 📊 현재 프로젝트 상태 (2025-08-26 23:55 기준)

### ✅ 완료된 것들

- [x] 기존 Giscus 댓글 시스템 코멘트아웃
- [x] Mock 데이터 생성 (6개 댓글/대댓글)
- [x] CommentItem 컴포넌트 (개별 댓글 렌더링)
- [x] CommentForm 컴포넌트 (댓글 작성 폼)
- [x] CommentSection 컴포넌트 (댓글 섹션 메인)
- [x] 블로그 포스트에 새로운 댓글 시스템 통합
- [x] date-fns 의존성 설치
- [x] 댓글 UI 디자인 최적화
- [x] 댓글 구분선 추가
- [x] 대댓글 화살표 표시 시스템
- [x] 상대적/절대적 시간 표시 시스템 (초 단위까지)
- [x] 1000글자 댓글 길이 제한
- [x] 다국어 지원 (한국어/일본어)
- [x] 다크모드 지원
- [x] CSS 격리 (`not-prose` 클래스)
- [x] TanStack Query 설정 및 Provider 구성
- [x] 커스텀 훅으로 댓글 관리 로직 구현
- [x] 토스트 알림 시스템 (성공/에러)
- [x] 자동 새로고침 시스템
- [x] 에러 처리 및 사용자 피드백
- [x] 댓글 간격 최적화
- [x] **실제 API 서버와 연동 완료**
- [x] **복합 키 시스템으로 댓글 고유 식별**
- [x] **환경별 API URL 설정 (로컬/프로덕션)**
- [x] **데이터베이스 분리 (dev_comments/prod_comments)**
- [x] **API 응답 파싱 최적화**
- [x] **실시간 댓글 작성/조회/대댓글 완벽 동작**

### 🚧 다음 단계 예정

- [ ] **API 서버 프로덕션 배포 (Vercel)**
- [ ] **AI 봇 시스템 구현**
- [ ] **관리자 대시보드 개발**
- [ ] **추가 기능 (좋아요, 신고 등)**

---

## 💡 개발 팁 & 노하우

### **댓글 시스템 설계**

- **Mock 데이터 우선**: 완벽한 API 없이도 UI/UX 완성 가능
- **컴포넌트 분리**: CommentItem, CommentForm, CommentSection으로 명확한 책임 분리
- **사양서 준수**: `design.md`의 요구사항을 정확히 구현하여 일관성 확보

### **UI/UX 최적화**

- **불필요한 요소 제거**: 제목, 라벨 등 사용자가 직관적으로 알 수 있는 요소는 제거
- **일관된 스타일링**: Tailwind CSS의 체계적인 클래스 사용으로 일관된 디자인
- **반응형 고려**: 모바일과 데스크톱 모두에서 적절한 UI 제공

### **시간 표시 시스템**

- **상대적 시간**: 24시간 이내는 "~전" 형태로 직관적 표시
- **절대적 시간**: 24시간 이상은 정확한 날짜와 시간으로 표시
- **초 단위 정밀도**: 사용자가 댓글의 최신성을 정확히 파악 가능

### **CSS 격리**

- **`not-prose` 클래스**: Tailwind CSS에서 제공하는 prose 스타일 차단 클래스
- **블로그 CSS 영향 방지**: MDX 콘텐츠와 댓글 시스템의 스타일 분리
- **일관된 디자인**: 댓글 시스템이 블로그 스타일에 영향받지 않는 독립적인 UI

### **TanStack Query 활용**

- **캐시 관리**: 자동 백그라운드 업데이트 및 캐시 무효화
- **상태 관리**: 로딩, 성공, 에러 상태 자동 처리
- **자동 새로고침**: 댓글 작성 후 즉시 목록 업데이트

### **에러 처리 및 사용자 경험**

- **토스트 알림**: 성공/실패 시 즉시 피드백 제공
- **적절한 에러 메시지**: 사용자가 문제를 이해하고 해결할 수 있는 안내
- **다국어 지원**: 한국어/일본어 사용자 모두를 위한 친화적 메시지

### **API 연동 및 환경 관리**

- **환경변수 분리**: 로컬과 프로덕션 환경을 명확하게 구분
- **복합 키 시스템**: 언어/카테고리/슬러그 조합으로 댓글 고유 식별
- **안전한 설정**: 환경변수 누락 시 빌드 실패로 잘못된 배포 방지
- **데이터베이스 분리**: 개발/프로덕션 환경별 테이블 분리로 데이터 안전성 확보

### **백엔드 연동 최적화**

- **응답 구조 유연성**: 다양한 API 응답 형태에 대응 가능한 파싱 로직
- **실시간 업데이트**: 댓글 작성 후 즉시 목록 새로고침으로 사용자 경험 향상
- **에러 처리**: API 실패 시 적절한 사용자 피드백 및 fallback 처리

---

## 🎯 다음 세션 계획

**목표**: API 서버 프로덕션 배포 및 추가 기능 개발  
**우선순위**:

1. **API 서버 프로덕션 배포 (Vercel)**

   - `prod_comments` 테이블 연동
   - 환경변수 설정 (`NEXT_PUBLIC_COMMENT_PROD_API_BASE_URL`)
   - GitHub Pages와 연동 테스트

2. **AI 봇 시스템 구현**

   - 웹훅 엔드포인트 구현
   - LLM API 연동
   - 자동 댓글 생성 로직

3. **관리자 대시보드 개발**

   - 로그인 기능
   - 댓글 관리 UI
   - AI 댓글 승인 시스템

4. **추가 기능 개발**

   - 댓글 좋아요 시스템
   - 댓글 신고 기능
   - 스팸 필터링

---

_마지막 업데이트: 2025-08-26 23:55 (API 연동 완성, 환경변수 설정, 프로덕션 준비 완료)_
