# .github/workflows/trigger-comment-bot.yml

name: ğŸš€ Trigger Comment Bot on New Post

on:
  push:
    branches:
      - main
    paths:
      - 'src/posts/weekly/**/*.mdx'

jobs:
  trigger-on-new-post:
    name: Check for New Posts and Trigger
    runs-on: ubuntu-latest
    steps:
      - name: Wait 5 minutes
        run: sleep 300

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get list of new mdx files
        id: get_new_posts
        run: |
          FILES=$(git diff --name-only --diff-filter=A HEAD^ HEAD | grep "src/posts/weekly/.*\.mdx$" || true)
          # ì¶œë ¥ì„ ìœ„í•´ EOF delimiterë¥¼ ì‚¬ìš©í•˜ê³ , ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ë³€ìˆ˜ ì „ë‹¬
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Trigger webhook for each new post
        if: steps.get_new_posts.outputs.files != ''
        run: |
          # while ë£¨í”„ë¥¼ ì‚¬ìš©í•˜ì—¬ ê° íŒŒì¼ ê²½ë¡œë¥¼ ì•ˆì •ì ìœ¼ë¡œ ì²˜ë¦¬
          echo "${{ steps.get_new_posts.outputs.files }}" | while IFS= read -r file; do
            if [ -z "$file" ]; then continue; fi

            echo "Processing file: $file"
            
            # íŒŒì¼ ê²½ë¡œì—ì„œ ë””ë ‰í† ë¦¬ ë¶€ë¶„ë§Œ ì¶”ì¶œ (ì˜ˆ: src/posts/weekly/250406)
            DIR_PATH=$(dirname "$file")
            
            # 'src/posts/' ë¶€ë¶„ì„ ì œê±°í•˜ì—¬ post_id ìƒì„± (ì˜ˆ: weekly/250406)
            POST_ID_DIR=$(echo "$DIR_PATH" | sed 's|^src/posts/||')

            # íŒŒì¼ ì´ë¦„ì—ì„œ ì–¸ì–´ ì½”ë“œ ì¶”ì¶œ (ì˜ˆ: content_ja.mdx -> ja)
            FILENAME=$(basename "$file")
            LANG=$(echo "$FILENAME" | sed -n 's/content_\(ko\|ja\)\.mdx/\1/p')

            # ìµœì¢… post_id ì™€ URL ìƒì„±
            POST_ID="${LANG}/${POST_ID_DIR}"
            URL="https://mintora.me/blog/${LANG}/posts/${POST_ID_DIR}"

            echo "Triggering for Post ID: ${POST_ID}"
            echo "URL: ${URL}"
            
            # JSON ë³¸ë¬¸ê³¼ í•¨ê»˜ ì›¹í›… POST ìš”ì²­ ë³´ë‚´ê¸°
            curl -X POST -H "Content-Type: application/json" \
              -d "{\"post_id\": \"${POST_ID}\", \"url\": \"${URL}\"}" \
              "${{ secrets.WEBHOOK_URL }}"
          done
