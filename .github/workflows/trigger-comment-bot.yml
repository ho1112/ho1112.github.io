name: ğŸš€ Trigger Comment Bot on New Post

on:
  push:
    branches:
      - main
    paths:
      - 'src/posts/**.mdx' # src/posts í´ë” í•˜ìœ„ì˜ .mdx íŒŒì¼ ë³€ê²½ ì‹œì—ë§Œ ì‹¤í–‰

jobs:
  trigger-on-new-post:
    name: Check for New Posts and Trigger
    runs-on: ubuntu-latest
    steps:
      # Git íˆìŠ¤í† ë¦¬ë¥¼ ê°€ì ¸ì™€ íŒŒì¼ ë³€ê²½ ë‚´ì—­ì„ ë¹„êµí•˜ê¸° ìœ„í•´ í•„ìš”í•©ë‹ˆë‹¤.
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # HEAD^ì™€ ë¹„êµí•˜ê¸° ìœ„í•´ ì´ì „ ì»¤ë°‹ ê¸°ë¡ê¹Œì§€ ê°€ì ¸ì˜µë‹ˆë‹¤.
          fetch-depth: 2

      # ì´ë²ˆ pushì—ì„œ 'ì¶”ê°€(Added)'ëœ .mdx íŒŒì¼ ëª©ë¡ì„ ì°¾ìŠµë‹ˆë‹¤.
      - name: Get list of new mdx files
        id: get_new_posts
        run: |
          # git diff ëª…ë ¹ì–´ë¡œ 'ì¶”ê°€(A)'ëœ 'src/posts/**/*.mdx' íŒŒì¼ ëª©ë¡ì„ ì°¾ìŠµë‹ˆë‹¤.
          # || true ëŠ” íŒŒì¼ì´ ì—†ì„ ë•Œ ì—ëŸ¬ê°€ ë°œìƒí•˜ëŠ” ê²ƒì„ ë°©ì§€í•©ë‹ˆë‹¤.
          FILES=$(git diff --name-only --diff-filter=A HEAD^ HEAD | grep "src/posts/.*\.mdx$" || true)

          # ì°¾ì€ íŒŒì¼ ëª©ë¡ì„ ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ OUTPUTìœ¼ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # ìƒˆë¡œ ì¶”ê°€ëœ íŒŒì¼ì´ ìˆì„ ë•Œë§Œ ì›¹í›…ì„ í˜¸ì¶œí•©ë‹ˆë‹¤.
      - name: Trigger webhook for each new post
        if: steps.get_new_posts.outputs.files != ''
        run: |
          # ì—¬ëŸ¬ íŒŒì¼ì´ í•œ ë²ˆì— ì¶”ê°€ë  ìˆ˜ ìˆìœ¼ë¯€ë¡œ, for ë£¨í”„ë¥¼ ì‚¬ìš©í•´ ê°ê° ì²˜ë¦¬í•©ë‹ˆë‹¤.
          # íŒŒì¼ ëª©ë¡ì„ ë°°ì—´ë¡œ ë³€í™˜í•˜ì—¬ ì²˜ë¦¬
          IFS=$'\n' read -d '' -r -a FILES_ARRAY <<< "${{ steps.get_new_posts.outputs.files }}"

          for file in "${FILES_ARRAY[@]}"; do
            # íŒŒì¼ ê²½ë¡œì—ì„œ ì •ë³´ ì¶”ì¶œ
            # ì˜ˆ: src/posts/weekly/250406/content_ja.mdx
            
            # ì¹´í…Œê³ ë¦¬ì™€ ë‚ ì§œ ì¶”ì¶œ (ì˜¬ë°”ë¥¸ ì¸ë±ìŠ¤ ì‚¬ìš©)
            CATEGORY=$(echo "$file" | awk -F'/' '{print $3}')
            DATE=$(echo "$file" | awk -F'/' '{print $4}')
            
            # ì–¸ì–´ ì½”ë“œ ì¶”ì¶œ (content_ja.mdx â†’ ja)
            LANG=$(echo "$file" | awk -F'/' '{print $5}' | sed 's/content_//' | sed 's/\.mdx$//')

            # ìš°ë¦¬ API í˜•ì‹ì— ë§ê²Œ post_id ìƒì„± (ì–¸ì–´ë¥¼ ì•ìœ¼ë¡œ)
            POST_ID="${LANG}/${CATEGORY}/${DATE}"
            URL="https://mintora.me/blog/${LANG}/${CATEGORY}/${DATE}"
            
            echo "Triggering for Post ID: ${POST_ID}"
            echo "Category: ${CATEGORY}"
            echo "Date: ${DATE}"
            echo "Language: ${LANG}"
            echo "URL: ${URL}"
            
            # JSON ë³¸ë¬¸ê³¼ í•¨ê»˜ ì›¹í›… POST ìš”ì²­ì„ ë³´ëƒ…ë‹ˆë‹¤.
            curl -X POST -H "Content-Type: application/json" \
              -d "{\"post_id\": \"${POST_ID}\", \"url\": \"${URL}\"}" \
              ${{ secrets.WEBHOOK_URL }}
          done
